pipeline {

    environment
	{
		registry = "abdallahbe/time"
		registryCredential= 'dockerHub'
		dockerImage = ''
	}
    agent any

    stages {
		stage('Cloning our Git') {
			steps { 
				git 'https://github.com/abdallahbe/time.git'
			}
		}
		stage('Building our image') {
			steps { 
				script { 
					dockerImage= docker.build registry + ":0.0.1" 
				} 
			}
		}
		stage('Deploy our image') {
			steps { 
				script { 
					docker.withRegistry( '', registryCredential) { dockerImage.push() } 
					} 
				}
		}
		stage('Cleaning up') {
			steps { 
				bat "docker rmi $registry:0.0.1" 
			}
		}
        


    stages {
       stage ('GIT') {
            steps {
               echo "Getting Project from Git"; 
                git branch: "abdallah", 
                    url: "https://github.com/abdallahbe/time.git";
                 
            }
        } 
        

        stage("Build") {
            steps {
                bat "mvn -version"
                bat "mvn clean package -DskipTests"
                // sh "mvn clean package -DskipTests" pour une machine linux
            }
        }
       
        stage ('MVN TEST') {
            steps {
                echo "Maven Test JUnit";
                bat 'mvn test';
            }
        }
        
        stage("Sonar") {
            steps {
                bat "mvn sonar:sonar"
            }
        }
        
        stage("DEPLOY") {
            steps {
                bat "mvn clean package deploy:deploy-file -DgroupId=tn.esprit.spring -DartifactId=timesheet -Dversion=1.3 -DgeneratePom=true -Dpackaging=jar -DrepositoryId=deploymentRepo -Durl=http://localhost:8081/repository/maven-releases/ -Dfile=target/timesheet-1.3.jar -Dmaven.test.skip=true"
            }
        }
       
    }
   
  
    
}
